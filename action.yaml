name: "Infracost Core"
description: "Render current vs future cloud cost table and comment on PR"
inputs:
  working_dir:
    description: "Directory that contains tfplan.json for the PR plan"
    required: true
  base_tfplan_path:
    description: "Absolute path to baseline tfplan.json to compare against"
    required: true
  currency:
    description: "Currency code, e.g., USD, EUR, INR"
    required: false
    default: USD
  ping_author:
    description: "Ping PR author in the comment"
    required: false
    default: "true"
  mention_handles:
    description: "Space-separated or @-prefixed handles to mention"
    required: false
    default: ""
  infracost_version:
    description: "Infracost CLI version"
    required: false
    default: "latest"
  comment_marker:
    description: "Marker to allow updates"
    required: false
    default: "<!-- infracost-comment -->"

runs:
  using: "composite"
  steps:
    - uses: actions/setup-python@v6
      with:
        python-version: "3.x"

    - name: Install Infracost
      shell: bash
      run: |
        set -euo pipefail
        ver="${{ inputs.infracost_version }}"
        curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
        echo "Installed $(infracost --version)"

    - name: Resolve paths
      id: paths
      shell: bash
      run: |
        set -euo pipefail
        WD="${{ inputs.working_dir }}"
        BASE="${{ inputs.base_tfplan_path }}"
        # absolutize working dir relative to workspace if needed
        if [[ "$WD" != /* ]]; then WD="${GITHUB_WORKSPACE%/}/$WD"; fi
        if [[ ! -f "$BASE" ]]; then
          echo "Error: base_tfplan_path not found: $BASE" >&2
          exit 1
        fi
        echo "wd=$WD" >> "$GITHUB_OUTPUT"
        echo "base=$BASE" >> "$GITHUB_OUTPUT"

    - name: Build diff JSON (baseline vs PR)
      shell: bash
      env:
        INFRACOST_API_KEY: ${{ env.INFRACOST_API_KEY }}
      run: |
        set -euo pipefail
        WD='${{ steps.paths.outputs.wd }}'
        BASE='${{ steps.paths.outputs.base }}'
        CUR='USD'
        [[ -n "${{ inputs.currency }}" ]] && CUR="${{ inputs.currency }}"

        # Optional: write a baseline breakdown JSON (handy artifact)
        infracost breakdown \
          --path "$BASE" \
          --currency "$CUR" \
          --format json \
          --out-file "$WD/.infracost-base.json"

        # The important one: DIFF current PR plan (tfplan.json) vs baseline tfplan.json
        infracost diff \
          --path "$WD/tfplan.json" \
          --compare-to "$BASE" \
          --currency "$CUR" \
          --format json \
          --out-file "$WD/infracost.out.json"

        echo "Wrote $WD/infracost.out.json"

    - name: Generate PR comment markdown
      shell: bash
      env:
        PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        MENTION_HANDLES: ${{ inputs.mention_handles }}
        INPUT_COMMENT_MARKER: ${{ inputs.comment_marker }}
      run: |
        set -euo pipefail
        WD='${{ steps.paths.outputs.wd }}'
        PY="$GITHUB_WORKSPACE/.github/scripts/infracost_comment.py"
        if [[ ! -f "$PY" ]]; then
          echo "Missing script: $PY" >&2
          exit 1
        fi
        python "$PY" "$WD/infracost.out.json" "$WD/infracost_comment.md"

    - name: Create/Update PR comment
      uses: actions/github-script@v7
      env:
        PING_AUTHOR: ${{ inputs.ping_author }}
        WD: ${{ steps.paths.outputs.wd }}
        MARKER: ${{ inputs.comment_marker }}
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          const { owner, repo } = context.repo;
          const pr = context.payload.pull_request;
          if (!pr) return;
          const issue_number = pr.number;
          const pingAuthor = (process.env.PING_AUTHOR || 'true').toLowerCase() === 'true';
          const author = pr.user.login;
          const bodyBase = fs.readFileSync(path.join(process.env.WD, 'infracost_comment.md'), 'utf8');
          const body = (pingAuthor ? `@${author}\n\n` : '') + bodyBase;
          const marker = process.env.MARKER || '<!-- infracost-comment -->';
          const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number });
          const existing = comments.find(c => c.body && c.body.includes(marker));
          if (existing) {
            await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
          } else {
            await github.rest.issues.createComment({ owner, repo, issue_number, body });
          }